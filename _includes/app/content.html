<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diode Network Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #ffffff;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    .dashboard {
      max-width: 1392px;
      margin: 20px auto;
      padding: 0 20px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      gap: 24px;
    }

    .left-column {
      width: 920px;
      margin-bottom: 55px;
      margin-top: 20px;
    }

    .content-box {
      background-color: #FAFAFA;
      padding: 14px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 2px rgba(0, 0, 0, 0.1);
      flex: 1;
    }

    .content-box h3 {
      font-size: 20px;
      font-weight: 500;
      color: #141414;
      margin-top: 0;
    }

    .tables-row {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-top: 24px;
      margin-bottom: 20px;
      background-color: hsl(0, 0%, 100%);
    }

    .table {
      width: 100%;
      background-color: #FAFAFA;
      border-collapse: separate;
      border-spacing: 0 8px;
      margin-top: 10px;
      text-align: left;
    }

    .table tr {
      margin-bottom: 8px;
    }

    .table-box {
      padding: 10px 16px;
      background-color: #FAFAFA;
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
    }

    .table th {
      font-size: 12px;
      color: #141414;
      font-weight: 600;
      text-transform: uppercase;
      padding: 4px 7px;
      text-align: left;
      white-space: nowrap;
      height: 32px;
    }

    .table td {
      font-size: 12px;
      color: #5E5E5E;
      font-weight: 400;
      padding: 4px 7px;
      background-color: #ffffff;
      text-align: left;
      align-items: flex-start;
      height: 32px;  
      margin-bottom: 6px; 
      word-wrap: none;
      white-space: nowrap;
    }

    .clickable-row {
      background-color: #ffffff;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .clickable-row:hover {
      background-color: #e8e9e9 !important;
    }

    .clickable-row td {
      background-color: transparent;
    }

    .table th.address-col {
      width: 120px; 
      max-width: 120px;
    }

    .table th.description-col {
      width: auto;
      min-width: 120px;  
    }

    .table td.description-col {
      white-space: normal;
      word-wrap: break-word;
    }

    .table td.address-col {
      font-family: monospace;
    }

    .table-title {
      font-size: 16px;
      margin: 0px;
      color: #141414;
      font-weight: 500;
      display: flex;
      justify-content: center;
      align-items: center;
      text-transform: uppercase;
    }

    .table-box::-webkit-scrollbar {
      width: 5px;
      max-height: 10px;
    }

    .table-box::-webkit-scrollbar-track {
      background: white;
      max-height: 10px;
    }

    .table-box::-webkit-scrollbar-thumb {
      background: rgb(209, 209, 209);
      border-radius: 10px;
      max-height: 10px;
    }

    .scroller::-webkit-scrollbar-button:start:increment {
      height: 25%;
      display: block;
      background: transparent;
    }

    .button-open-camp {
      background: linear-gradient(to right, #D73E53 0%, #A04992 48%, #615BA8 100%);
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      font-size: 14px;
      height: 44px;
      cursor: pointer;
      border: none;
    }

    .button-view-all {
      background-color: #ffffff;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      color: #000000;
      border: 1px solid #000000;
      padding: 8px 26px;
      border-radius: 5px;
      font-size: 10px;
    }

    .button-view-all:hover {
      background-color: #000000;
      color: #ffffff;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 30px;
      background: linear-gradient(to right, #D73E53 0%, #A04992 48%, #615BA8 100%);
      color: white;
      border-radius: 0px;
      margin-bottom: 30px;
    }

    .dashboard-header .title {
      font-size: 20px;
      font-weight: medium;
    }

    .dashboard-header .buttons {
      display: flex;
      gap: 10px;
    }

    .dashboard-header button {
      padding: 8px 15px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }

    .open-campaign {
      background-color: black;
      font-family: 'Poppins', sans-serif;
      color: white;
    }



    .rank-container {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    .rank-box {
      display: flex;
      align-items: center;
      padding: 0px 30px;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      height: 121px;
      min-width: 400px;
    }

    .epoch-rank {
      background: linear-gradient(to right, #D73E53 0%, #A04992 48%, #615BA8 100%);
      justify-content: center;
      align-items: center;
      display: flex;
    }

    .epoch-rank:hover {
      cursor: pointer;
    }

    .epoch-points {
      color: black;
      justify-content: center;
      align-items: center;
      display: flex;
      min-width: 200px;
    }

    .rank-title {
      font-size: 20px;
      margin-right: 20px;
    }

    .rank-value {
      font-size: 32px;
    }

    .boost {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 89px;
      height: 89px;
      border: 5px solid #151515;
      border-radius: 15px;
      text-align: center;
      font-size: 14px;
      background: white;
      position: relative;
      overflow: hidden;
    }

    .boost-inner {
      transform: rotate(-45deg);
      text-align: center;
      width: 100%;
    }

    .boost-inner p {
      margin: 0;
      width: 100%;
      text-align: center;
    }

    .boost-p-number {
      font-weight: 700;
      font-size: 24px;
      background: linear-gradient(to right, #D73E53, #A04992, #615BA8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .boost-p-text {
      color: #141414;
    }

    .boost-box {
      margin-left: 30px;
      padding: 2px;
      min-width: 100px;
      height: 100px;
      border: 2px solid #151515;
      border-radius: 20px;
      transform: rotate(45deg);
      position: relative;
      overflow: hidden;
    }

    .boost span {
      transform: rotate(-45deg);
    }

    .modal-stat {
      overflow:hidden; 
      text-overflow:ellipsis; 
      white-space:nowrap;
    }

    .coin {
      width: 24px;
      height: 24px;
      background-color: gold;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: black;
      margin-left: 8px;
    }

    .container {
      display: flex;
      gap: 20px;
    }

    .card {
      background: #FAFAFA;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #D73E53;
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
    }

    .card-main-title {
      font-size: 16px;
      font-weight: 500;
      color: #141414;
    }

    .card h2 {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .card-number {
      font-size: 32px;
      font-weight: bold;
      color: #151515;
      height: 10px;
    }

    .card-title {
      padding: 20px 16px;
      background-color: #ffffff;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fafafa;
      padding: 20px;
      border-radius: 8px;
      width: 95%;
      max-width: 1400px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      margin: 0;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 500;
      color: #141414;
    }

    .rank-highlight {
      background-color: #D73E53 !important;
      color: #fff !important;
    }

    .close-modal {
      margin-right:30px;
      cursor: pointer;
      font-size: 24px;
      color: #5E5E5E;
    }

    .modal .table td {
      max-width: none;
      white-space: normal;
    }

    .modal .table th {
      max-width: none;
      white-space: normal;
    }

    .modal .table td.address-col {
      white-space: normal;
      font-family: monospace;
      word-break: break-all;
      min-width: 350px;
      max-width: 400px;
    }

    .modal .table td.description-col {
      white-space: normal;
      min-width: 200px;
    }

    @media (max-width: 768px) {
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
      }

      .close-modal {
        margin-right:20px;
      }

      .modal-content {
        width: 95%;
        padding: 2px;
        margin: 0;
        max-height: 90vh;
      }

      .modal-header {
        margin-bottom: 15px;
      }

      .modal-title {
        font-size: 16px;
      }

      .modal .table th,
      .modal .table td {
        padding: 8px;
        font-size: 12px;
      }
    }

    @media (max-width: 480px) {
      .modal-content {
        width: 95%;
        padding: 10px;
      }

      .modal-title {
        font-size: 14px;
      }

      .modal .table th,
      .modal .table td {
        padding: 6px;
        font-size: 11px;
      }

      .modal .table td.address-col {
        min-width: 150px;
        max-width: 200px;
      }

      .close-modal {
        font-size: 20px;
        margin-right: 20px;
      }
    }

    @media (max-width: 768px) {
      .airlyft-sidebar {
        width: 100%;
        right: -100%;
      }

      
    }

    @media (max-width: 1200px) {
      .rank-container {
        flex-wrap: wrap;
        margin-bottom: 30px;
        gap: 20px;
      }

      .rank-box {
        width: 100%;
        height: 100px;
      }

      .boost-box {
        margin: 0 auto;
        margin-top: 10px;
      }
    }

    @media (max-width: 992px) {
      .container {
        flex-wrap: wrap;
        gap: 20px;
      }

      .card {
        width: 100%;
      }

      .tables-row {
        flex-direction: column;
      }

      .content-box {
        margin-bottom: 20px;
      }
    }

    @media (max-width: 768px) {
      .dashboard {
        padding: 0 20px;
        overflow-x: hidden;
        margin: 0;
      }

      .dashboard-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
        padding: 20px;
        margin-bottom: 23px;
      }

      .dashboard-header .title {
        text-align: left;
      }

      .dashboard-header .buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-end;
      }

      .dashboard-header button {
        font-size: 12px;
        width: 150px;
        min-height: 34px;
      }

      .rank-container {
        flex-direction: row;
        gap: 12px;
        margin-bottom: 30px;
      }

      .boost-box {
        order: 2;
        margin: 0;
        min-width: 90px;
        margin-top: 20px;
      }

      .rank-box.epoch-rank {
        order: 1;
        min-height: 74px;
        max-width: 94%;
      }

      .rank-container {
        flex-direction: column;
        gap: 12px;
        margin-bottom: 30px;
      }

      .rank-box {
        width: 100% !important;
        min-width: unset;
        height: 73px;
        padding: 0 15px;
      }

      .rank-title {
        font-size: 16px;
      }

      .rank-value {
        font-size: 24px;
      }

      .boost-p-number {
        font-size: 24px;
      }

      .boost-p-text {
        font-size: 12px;
      }

      .card {
        width: 100%;
      }

      .table-title {
        font-size: 14px !important;
      }

      .button-view-all {
        padding: 6px 20px;
      }

    }

    .boosted-indicator {
      display: none;
      font-size: 14px;
      color: #A04992;
      text-align: left;
      margin-top: 2px;
      margin-left: 2px;
    }

    @media (max-width: 480px) {
      .dashboard {
        padding: 0 10px;
      }

      .dashboard-header {
        padding: 15px;
        justify-content: center;
        align-items: center;
        display: flex;
      }

      .dashboard-header .title {
        font-size: 16px;
        width: 100%;
      }

      .address-copy {
        background-color: #1E1E1E;
        height: 43px;
        font-size: 10px;
        justify-content: center;
        align-items: center;
        display: flex;
      }

      .dashboard-header button {
        font-size: 12px;
        width: 150px;
        min-height: 34px;
      }

      .rank-container {
        gap: 10px;
      }

      .rank-box {
        padding: 0 10px;
      }

      .rank-title {
        font-size: 16px;
      }

      .rank-value {
        font-size: 24px;
      }

      .row {
        flex-direction: column;
        gap: 15px;
      }

      .left-column {
        width: 100% !important;
        margin-bottom: 30px;
      }

      .card-number {
        font-size: 28px;
      }

      .table th,
      .table td {
        font-size: 10px;
        padding: 8px;
      }

      .dashboard-header .buttons {
        flex-direction: column;
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      if (!window.ethereum) {
        window.location.href = "{{ '/wallet/' | relative_url }}";
        return;
      }
      try {
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (!accounts || accounts.length === 0) {
          window.location.href = "{{ '/wallet/' | relative_url }}";
        }
      } catch (err) {
        console.error('Failed to retrieve accounts:', err);
        window.location.href = "{{ '/wallet/' | relative_url }}";
      }
    });
  </script>

  <div class="dashboard">
    <div class="row">
      <div class="rank-container" id="rankContainer">
        <div class="rank-box epoch-rank">
          <span class="rank-title">Epoch Rank: </span>
          <span class="rank-value" id="epochRankValue">-</span>
          <span class="rank-title">&nbsp;&nbsp;&nbsp;of</span>
          <span class="rank-value participants-view-all" id="epochParticipantsValue">-</span>
        </div>
        <div class="rank-box epoch-points" style="display: flex; flex-direction: column; align-items: center;">
          <div style="display: flex; align-items: center;">
            <span class="rank-title">Total Points: </span>
            <span class="rank-value" id="epochPointsValue">-</span>
          </div>
          <div id="boostedIndicator" class="boosted-indicator">
            Boosted!
          </div>
        </div>
        <div class="boost-box">
          <div class="boost">
            <div class="boost-inner">
              <p class="boost-p-number" id="boostValue">0%</p>
              <p class="boost-p-text">BOOST</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="card" id="nodesCard" style="border: 1px solid #D73E53;">
        <div class="card-title">
          <div style="display: flex; align-items: center; gap: 8px;">
            <img src="{{ 'assets/images/icons/node.png' | relative_url }}" alt="Node Icon" />
            <div>
              <p class="card-main-title"><span id="nodesCount">0</span> NODES</p>
            </div>
          </div>
          <div
            style="margin-top: -40px; display: flex; flex-direction: column; align-items: center; text-align: center;">
            <p><span class="card-number" id="nodePoints">0</span> Points</p>
            <p style="font-size: 12px; color: #5E5E5E;" id="nodesBandwidth"></p>
            <p style="font-size: 12px; color: #FF0000;" id="nodesStakeWindow"></p>
          </div>
        </div>
        <div class="table-header" style="background-color: #FAFAFA; padding: 10px 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="table-title">YOUR NODES</h3>
            <button class="button-view-all">View All</button>
          </div>
          <hr style="border: 0.3px solid #E6E6E6; margin: 8px 0;">
          <div class="table-box" style="overflow-y: auto; overflow-x: auto; max-height: 400px;">

            <table class="table">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Points</th>
                  <th class="address-col">Address</th>
                  <th class="description-col">DESCRIPTION</th>
                </tr>
              </thead>
              <tbody id="nodesTableBody">
                <tr>
                  <td colspan="4">Loading data...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>

      <div class="card" id="zonesCard" style="border: 1px solid #A04992;">
        <div class="card-title">
          <div style="display: flex; align-items: center; gap: 8px;">
            <img src="{{ 'assets/images/icons/location.png' | relative_url }}" alt="Location Icon" />
            <div>
              <p class="card-main-title"><span id="zonesCount">0</span> ZONES</p>
            </div>
          </div>
          <div
            style="margin-top: -40px; display: flex; flex-direction: column; align-items: center; text-align: center;">
            <p><span class="card-number" id="zonePoints">0</span> Points</p>
            <p style="font-size: 12px; color: #5E5E5E;" id="zonesUsers">
            </p>
          </div>
        </div>
        <div class="table-header" style="background-color: #FAFAFA; padding: 10px 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="table-title">YOUR ZONES</h3>
            <button class="button-view-all">View All</button>
          </div>
          <hr style="border: 0.3px solid #E6E6E6; margin: 8px 0;">
          <div class="table-box" style="overflow-y: auto; overflow-x: auto; max-height: 400px;">

            <table class="table">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Active Users</th>
                  <th class="address-col">ADDRESS</th>
                  <th class="description-col">DESCRIPTION</th>
                </tr>
              </thead>
              <tbody id="zonesTableBody">
                <tr>
                  <td colspan="4">Loading data...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>

      <div class="card" id="referralsCard" style="border: 1px solid #615BA8;">
        <div class="card-title">
          <div style="display: flex; align-items: center; gap: 8px;">
            <img src="{{ 'assets/images/icons/reffer.png' | relative_url }}" alt="Referral Icon" />
            <div>
              <p class="card-main-title"><span id="childrenCount">0</span> REFERRALS</p>
            </div>
          </div>
          <div
            style="margin-top: -40px; display: flex; flex-direction: column; align-items: center; text-align: center;">
              <p>
                  <span class="card-number" id="potentialChildrenPoints" style="color: red; visibility: hidden;">0</span>
                  <span class="card-number" id="childrenPoints">0</span>
                <span> Points</span>
              </p>
            <p id="affiliateWarning" style="display: none; color: red; font-size: 12px; margin: 4px 0 0 0;">
              You must be an <a href="https://diode.foundation/docs/programs/diode_affiliate_program.html" target="_blank" style="text-decoration: underline; color: red;">active Affiliate</a> to get Referral Tree points!
            </p>
            <p style="font-size: 12px; color: #5E5E5E;" id="descendantCount"></p>
          </div>
        </div>
        <div class="table-header" style="background-color: #FAFAFA; padding: 10px 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="table-title">Your Referral Tree</h3>
            <button class="button-view-all">View All</button>
          </div>
          <hr style="border: 0.3px solid #E6E6E6; margin: 8px 0;">
          <div class="table-box" style="overflow-y: auto; max-height: 400px;">

            <table class="table">
              <thead>
                <tr>
                  <th>Tree Points</th>
                  <th>Referred User</th>
                  <th>Descendants</th> 
                </tr>
              </thead>
              <tbody id="referralsTableBody">
                <tr>
                  <td colspan="5">Loading data...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

    <div class="tables-row">
      <div class="content-box">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 class="table-title" style="font-size: 16px;">YOUR BOOSTS</h3>
          <!-- <button class="button-view-all">View All</button> -->
        </div>
        <hr style="border: 0.3px solid #E6E6E6; margin: 0;">
        <table class="table">
          <tr>
            <th>NFT</th>
            <th>Quantity</th>
            <th>Boost %</th>
          </tr>
          <tbody id="boostsTableBody"></tbody>
        </table>
      </div>
      <!-- <div class="content-box">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 class="table-title" style="font-size: 16px;">YOUR PAST
            REWARDS</h3>
          <button class="button-view-all">View All</button>
        </div>
        <hr style="border: 0.3px solid #E6E6E6; margin: 0;">
        <table class="table">
          <tr>
            <th>Epoch</th>
            <th>Reward</th>
            <th>Rank</th>
          </tr>
          <tr>
            <td>670</td>
            <td>100 DIODE</td>
            <td>745</td>
          </tr>
          <tr>
            <td>669</td>
            <td>400 DIODE</td>
            <td>12</td>
          </tr>
        </table>
      </div> -->
    </div>
  </div>


  <div id="participantsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">All Participants</h3>
        <span class="close-modal">&times;</span>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Epoch Rank</th>
            <th>Username</th>
            <th>Badges</th>
            <th>Points</th>
          </tr>
        </thead>
        <tbody id="participantsModalBody"></tbody>
      </table>
    </div>
  </div>


  <div id="nodesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">All Nodes</h3>
        <span class="close-modal">&times;</span>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Epoch Rank</th>
            <th>Points</th>
            <th>Bandwidth ETD</th>
            <th>Registered Balance</th>
            <th class="address-col">Address</th>
            <th class="description-col">Description</th>
          </tr>
        </thead>
        <tbody id="nodesModalBody"></tbody>
      </table>
    </div>
  </div>

  <div id="zonesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">All Zones</h3>
        <span class="close-modal">&times;</span>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Epoch Rank</th>
            <th>Active Users ETD</th>
            <th class="address-col">Address</th>
            <th class="description-col">Description</th>
          </tr>
        </thead>
        <tbody id="zonesModalBody"></tbody>
      </table>
    </div>
  </div>

  <div id="referralsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">All Referrals</h3>
        <span class="close-modal">&times;</span>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Referred User</th>
            <th>Tree Points</th>
            <th>Epoch Rank</th>
            <th>Descendants</th>
            <th>Nodes</th>
            <th>Zones</th>
          </tr>
        </thead>
        <tbody id="referralsModalBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Boosts Modal -->
  <div id="boostsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">All Boosts</h3>
        <span class="close-modal">&times;</span>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>NFT</th>
            <th>Quantity</th>
            <th>Boost %</th>
          </tr>
        </thead>
        <tbody id="boostsModalBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Past Rewards Modal -->
  <div id="rewardsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">All Past Rewards</h3>
        <span class="close-modal">&times;</span>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Epoch</th>
            <th>Reward</th>
            <th>Rank</th>
          </tr>
        </thead>
        <tbody id="rewardsModalBody">
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      function formatAddress(address) {
        if (!address) return '';
        return `${address.slice(0, 3)}…${address.slice(-7)}`;

      }

      function formatBandwidth(bandwidth) {
        if (!bandwidth) return '0';
        return (bandwidth / 1000000000).toFixed(2);
      }

      if (!window.ethereum) {
        window.location.href = "{{ '/wallet/' | relative_url }}";
        return;
      }

      try {
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (!accounts || accounts.length === 0) {
          window.location.href = "{{ '/wallet/' | relative_url }}";
          return;
        }
      } catch (err) {
        console.error('Failed to retrieve accounts:', err);
        window.location.href = "{{ '/wallet/' | relative_url }}";
        return;
      }

      const accounts = await window.ethereum.request({ method: 'eth_accounts' });
      const walletAddress = (accounts && accounts[0]) ? accounts[0] : null;
      if (!walletAddress) return;

      //const baseURL = "https://0x77cc2702af7176f3110ab6f5d3cadcb20e00e8e5.diode.link:8008/v1";
      const baseURL = "https://registrar-prod.diode.link:8008/v1";

      async function getData(endpoint) {
        try {
          const res = await fetch(`${baseURL}${endpoint}`, {
            method: "GET",
            headers: {
              "Authorization": walletAddress
            }
          });
          if (!res.ok) {
            console.warn("Fetch failed:", res.status, res.statusText);
            return null;
          }
          return await res.json();
        } catch (err) {
          console.error("Error fetching", endpoint, err);
          return null;
        }
      }

      document.getElementById("nodesStakeWindow").textContent = window.epochStakeWindow;

      // this will fill in the top boxes quickly
      const rankData = await getData("/user/rank");
      if (rankData) {
        document.getElementById("epochRankValue").textContent = typeof rankData.rank !== "undefined" ? rankData.rank : "0";
        document.getElementById("epochParticipantsValue").textContent = typeof rankData.participants !== "undefined" ? rankData.participants : "-";
        document.getElementById("epochPointsValue").textContent = typeof rankData.total_points !== "undefined" ? Math.ceil(rankData.total_points) : "-";
        if (typeof rankData.boost_percent !== "undefined" && typeof rankData.total_points !== "undefined") {
          if (rankData.boost_percent > 0) {
            document.getElementById("boostValue").textContent = Number(rankData.boost_percent).toFixed(2) + "%";
            if (rankData.total_points > 0) {
              // boost increases both tree points and direct points
              // total points (points) is a sum of boosted tree points and boosted direct points
              // therefore, boosted points is simply boosted percent * total points
              document.getElementById('boostedIndicator').textContent = `Boosted by ${Math.ceil(rankData.boost_percent/100 * rankData.total_points)} points!`;
              document.getElementById('boostedIndicator').style.display = 'block';
            } 
          }
        }
      }

      const referralTreeActive = typeof rankData.active_referral_tree !== "undefined" ? rankData.active_referral_tree : 0;

      const nodesData = await getData("/nodes/list");
      const nodesTbody = document.getElementById("nodesTableBody");
      if (Array.isArray(nodesData) && nodesData.length > 0) {
        const sortedNodes = [...nodesData].sort((a, b) => (a.rank || Infinity) - (b.rank || Infinity));

        nodesTbody.innerHTML = "";
        const totalBandwidth = sortedNodes.reduce((sum, node) => sum + (parseFloat(node.bandwidth) || 0), 0);
        const roundedTotalBandwidth = (totalBandwidth / 1000000000).toFixed(1);
        document.getElementById("nodesBandwidth").textContent = `from ${roundedTotalBandwidth} GB Bandwidth`;
        document.getElementById("nodesCount").textContent = sortedNodes.length;
        const totalNodePoints = sortedNodes.reduce((sum, n) => sum + (typeof n.points === 'number' ? n.points : 0), 0).toFixed(1);
        document.getElementById("nodePoints").textContent = Math.ceil(totalNodePoints);

        sortedNodes.forEach(node => {
          const tr = document.createElement("tr");
          tr.className = "clickable-row";
          tr.onclick = () => window.open(`https://diode.io/network/#/node/${node.address}`, '_blank');
          tr.innerHTML = `
              <td>${node.banned === 1 ? "BANNED" : node.rank}</td>
              <td>${typeof node.points === 'number' ? node.points.toFixed(1) : '0.0'}</td>
              <td class="address-col"><a href="https://diode.io/network/#/node/${node.address}" target="_blank" style="text-decoration: none; color: inherit;">${formatAddress(node.address)}</a></td>
              <td class="description-col">${node.meta}</td>
            `;
          nodesTbody.appendChild(tr);
        });
      } else {
        nodesTbody.innerHTML = `<tr><td colspan="4">No Nodes Found</td></tr>`;
        document.getElementById("nodesBandwidth").textContent = `from 0 GB Bandwidth`;
        document.getElementById("nodesCount").textContent = "0";
      }

      const zonesData = await getData("/zones/list");
      const zonesTbody = document.getElementById("zonesTableBody");
      if (Array.isArray(zonesData) && zonesData.length > 0) {
        const sortedZones = [...zonesData].sort((a, b) => (a.rank || Infinity) - (b.rank || Infinity));

        zonesTbody.innerHTML = "";
        const totalActiveUsers = sortedZones.reduce((sum, z) => sum + (z.activeusers || 0), 0);
        document.getElementById("zonesUsers").textContent = `from ${totalActiveUsers} Active User${totalActiveUsers == 1 ? "" : "s"}`;
        document.getElementById("zonesCount").textContent = sortedZones.length;
        const totalZonePoints = sortedZones.reduce((sum, z) => sum + (z.points || 0), 0);
        document.getElementById("zonePoints").textContent = Math.ceil(totalZonePoints);

        sortedZones.forEach(zone => {
          const tr = document.createElement("tr");
          tr.style.backgroundColor = "#ffffff";
          tr.style.color = "#5E5E5E";
          tr.innerHTML = `
              <td>${zone.banned === 1 ? "BANNED" : zone.rank}</td>
              <td>${zone.activeusers} users</td>
              <td class="address-col">${formatAddress(zone.address)}</td>
              <td class="description-col">${zone.meta}</td>
            `;
          zonesTbody.appendChild(tr);
        });
      } else {
        zonesTbody.innerHTML = `<tr><td colspan="4">No Zones Found</td></tr>`;
        document.getElementById("zonesUsers").textContent = `from 0 Active Users`;
        document.getElementById("zonesCount").textContent = "0";
      }

      const childrenData = await getData("/tree/list");
      const referralsTbody = document.getElementById("referralsTableBody");
      if (Array.isArray(childrenData) && childrenData.length > 0) {
        const sortedChildren = [...childrenData].sort((a, b) => (b.tree_points_to_parent || -Infinity) - (a.tree_points_to_parent || -Infinity));

        referralsTbody.innerHTML = "";
        document.getElementById("childrenCount").textContent = sortedChildren.length;
        const totalDescendants = sortedChildren.length + sortedChildren.reduce((sum, c) => sum + (c.descendants || 0), 0);
        document.getElementById("descendantCount").textContent = `from ${totalDescendants} Total Descendant${totalDescendants == 1 ? "" : "s"}`;
        const totalChildPoints = sortedChildren.reduce((sum, c) => sum + (c.tree_points_to_parent || 0), 0);
        possibleReferralTreePoints = Math.ceil(totalChildPoints);
        actualReferralTreePoints = Math.floor(rankData.tree_points / (1+rankData.boost_percent/100)); // calculate base tree_points to display

        if (!referralTreeActive) {
          const childrenPointsElem = document.getElementById("childrenPoints");
          childrenPointsElem.textContent = possibleReferralTreePoints;
          childrenPointsElem.style.color = "red";
          childrenPointsElem.style.textDecoration = "line-through";
          document.getElementById("affiliateWarning").style.display = "block";
        } else {
          // sometimes actualReferralTreePoints and possibleReferralTreePoints are within 1 point of each other,
          // so we just gut check against direct points - if possibleReferralTreePoints is greater than direct points,
          // then we show the strike through / warning
          let directPoints = (rankData.total_points - rankData.tree_points)/(1+rankData.boost_percent/100);
          if (actualReferralTreePoints < possibleReferralTreePoints && possibleReferralTreePoints > directPoints) {
            document.getElementById("potentialChildrenPoints").textContent = possibleReferralTreePoints;
            document.getElementById("potentialChildrenPoints").style.color = "red";
            document.getElementById("potentialChildrenPoints").style.textDecoration = "line-through";
            document.getElementById("potentialChildrenPoints").style.visibility = "visible";
            const affiliateWarningElem = document.getElementById("affiliateWarning");
            affiliateWarningElem.innerHTML = "<a href='https://diode.foundation/docs/programs/referral_tree.html#reward-calculation' target='_blank' style='text-decoration: underline; color: red;'>Limited by your direct points!</a>";
            affiliateWarningElem.style.display = "block";
          } else {
            document.getElementById("affiliateWarning").style.display = "none";
          }

          document.getElementById("childrenPoints").textContent = actualReferralTreePoints;
          document.getElementById("childrenPoints").style.color = "black";
          document.getElementById("childrenPoints").style.textDecoration = "none";
        }

        sortedChildren.forEach(child => {
          const tr = document.createElement("tr");
          tr.style.backgroundColor = "#ffffff";
          tr.style.color = "#5E5E5E";
          tr.innerHTML = `
              <td>${child.banned === 1 ? "BANNED" : child.tree_points_to_parent ? Number(child.tree_points_to_parent).toFixed(1) : '0.0'}</td>
              <td>@${child.username.split('.')[0]}</td>
              <td>${child.descendants !== undefined ? child.descendants || "-" : '-'}</td>
            `;
          referralsTbody.appendChild(tr);
        });
      } else {
        referralsTbody.innerHTML = `<tr><td colspan="5">No Referrals Found</td></tr>`;
        document.getElementById("childrenCount").textContent = "0";
        document.getElementById("descendantCount").textContent = `from 0 Total Descendants`;
      }

      const participantData = await getData("/users_by_rank");

      // Fetch boostsData and parse the JSON string inside the "boosts" field
      let boostsData = await getData("/boosts/list");
     
      const boostsTbody = document.getElementById("boostsTableBody");
      if (Array.isArray(boostsData) && boostsData.length > 0) {      
        const sortedBoosts = [...boostsData]
          .filter(b => b.boost_percentage !== 0)
          .sort((a, b) => (b.boost_percentage || -Infinity) - (a.boost_percentage || -Infinity));
        
        boostsTbody.innerHTML = "";

        sortedBoosts.forEach(boost => {
          const tr = document.createElement("tr");
          tr.style.backgroundColor = "#ffffff";
          tr.style.color = "#5E5E5E";
          tr.innerHTML = `
              <td>${boost.name}</td>
              <td>${boost.quantity}</td>
              <td>${boost.boost_percentage}</td>
            `;
          boostsTbody.appendChild(tr);
        });
        
      } else {
        
        boostsTbody.innerHTML = `<tr><td colspan="5">No Boosts Found</td></tr>`;
        document.getElementById("boostsCount").textContent = "0";
        document.getElementById("boostsPoints").textContent = `from 0 Total Boosts`;
        
      }

      
      let currentData = {
        participants: Array.isArray(participantData) ? participantData : [],
        nodes: Array.isArray(nodesData) ? nodesData : [],
        zones: Array.isArray(zonesData) ? zonesData : [],
        referrals: Array.isArray(childrenData) ? childrenData : [],
        boosts: Array.isArray(boostsData) ? boostsData : [],
        rewards: [
          { epoch: 670, reward: '100 DIODE', rank: 745 },
          { epoch: 669, reward: '400 DIODE', rank: 12 },
        ],
      };

      function showModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
      }
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
      }
      document.querySelectorAll('.close-modal').forEach(button => {
        button.onclick = function () {
          this.closest('.modal').style.display = 'none';
        };
      });
      window.onclick = function (event) {
        if (event.target.classList.contains('modal')) {
          event.target.style.display = 'none';
        }
      };

      if (currentData.participants.length) {
        document.querySelector('#rankContainer .epoch-rank').onclick = function () {
          const curUsername = document.getElementById('username').textContent.replace(/^@/, '');
          const sortedParticipants = [...currentData.participants].sort((a, b) => a.rank - b.rank);
          document.getElementById('participantsModalBody').innerHTML = sortedParticipants.map(user => `
              <tr>
                <td class="modal-stat ${user.username === curUsername ? `rank-highlight` : `` }" style="width:10%;">${user.rank}</td>
                <td class="modal-stat ${user.username === curUsername ? `rank-highlight` : `` }" style="width:10%;">
                  ${user.username.split('.')[0]}
                </td>
                <td class="modal-stat ${user.username === curUsername ? `rank-highlight` : `` }" style="width:10%;">
                  ${renderUserBadges(user)}
                </td>
                <td class="modal-stat ${user.username === curUsername ? `rank-highlight` : `` } style="width:10%;">${Math.ceil(user.points)}</td>
              </tr>
            `).join('');
          showModal('participantsModal');
        };
      }

      function renderUserBadges(user) {
        if (!Array.isArray(user.badges)) return "";

        // Check for the special case where badges is [""] (a single empty string)
        if (
          user.badges.length === 1 &&
          (user.badges[0] === "" || user.badges[0] === "''" || user.badges[0] === "['']")
        ) {
          return "";
        }

        return user.badges.map(badge => `
          <a href="../assets/images/badge-${badge}.png" target="_blank">
            <img src="../assets/images/badge-${badge}.png" alt="badge-${badge}" style="height:22px;vertical-align:middle;margin-left:4px;">
          </a>`).join('');
      }

      if (currentData.nodes.length) {
        document.querySelector('#nodesCard .button-view-all').onclick = function () {
          const sortedModalNodes = [...currentData.nodes].sort((a, b) => (a.rank || Infinity) - (b.rank || Infinity));
          document.getElementById('nodesModalBody').innerHTML = sortedModalNodes.map(node => `
              <tr>
                <td>${node.banned === 1 ? "BANNED" : node.rank}</td>
                <td>${typeof node.points === 'number' ? node.points.toFixed(1) : '0.0'}</td>
                <td>${formatBandwidth(node.bandwidth)} GB</td>
                <td>${typeof node.balance === 'number' ? node.balance.toFixed(1) : '0.0'} DIODE</td>
                <td class="address-col"><a href="https://diode.io/network/#/node/${node.address}" target="_blank" style="text-decoration: none; color: inherit;">${node.address}</a></td>
                <td class="description-col">${node.meta}</td>
              </tr>
            `).join('');
          showModal('nodesModal');
        };
      }
      if (currentData.zones.length) {
        document.querySelector('#zonesCard .button-view-all').onclick = function () {
          const sortedModalZones = [...currentData.zones].sort((a, b) => (a.rank || Infinity) - (b.rank || Infinity));
          document.getElementById('zonesModalBody').innerHTML = sortedModalZones.map(zone => `
              <tr>
                <td>${zone.banned === 1 ? "BANNED" : zone.rank}</td>
                <td>${zone.activeusers}</td>
                <td class="address-col">${zone.address}</td>
                <td class="description-col">${zone.meta}</td>
              </tr>
            `).join('');
          showModal('zonesModal');
        };
      }
      if (currentData.referrals.length) {
        document.querySelector('#referralsCard .button-view-all').onclick = function () {
          const sortedReferrals = [...currentData.referrals].sort((a, b) => {
            // Sort by tree_points_to_parent descending, treating undefined/null/NaN as 0
            const aPoints = Number(a.tree_points_to_parent) || 0;
            const bPoints = Number(b.tree_points_to_parent) || 0;
            return bPoints - aPoints;
          });
          document.getElementById('referralsModalBody').innerHTML = sortedReferrals.map(child => `
              <tr>
                <td>@${child.username.split('.')[0]}</td>
                <td>${child.banned === 1 ? "BANNED" : child.tree_points_to_parent ? Number(child.tree_points_to_parent).toFixed(1) : '0.0'}</td>
                <td>${child.banned === 1 ? "BANNED" : child.rank || '-'}</td>
                <td>${child.descendants !== undefined ? child.descendants || "-" : '-' }</td>
                <td>${child.nodes !== undefined ? child.nodes || "-" : '-' }</td>
                <td>${child.zones !== undefined ? child.zones || "-" : '-' }</td>
              </tr>
            `).join('');
          showModal('referralsModal');
        };
      }

      if (currentData.boosts.length) {
        document.querySelector('#boostsCard .button-view-all').onclick = function () {
          const sortedModalBoosts = [...currentData.boosts].sort((a, b) => (a.boost_percentage || Infinity) - (b.boost_percentage || Infinity));
          document.getElementById('boostsModalBody').innerHTML = sortedModalBoosts.map(boost => `
              <tr>
                <td>${boost.name}</td>
                <td>${boost.quantity}</td>
                <td>${boost.boost_percentage}</td>
              </tr>
            `).join('');
          showModal('boostsModal');
        };
      }

      currentData.rewards = [
        { epoch: 670, reward: '100 DIODE', rank: 745 },
        { epoch: 669, reward: '400 DIODE', rank: 12 },
      ];

      document.querySelector('.content-box:last-of-type .button-view-all').onclick = function () {
        document.getElementById('rewardsModalBody').innerHTML = currentData.rewards.map(r => `
            <tr>
              <td>${r.epoch}</td>
              <td>${r.reward}</td>
              <td>${r.rank}</td>
            </tr>
          `).join('');
        showModal('rewardsModal');
      };
    });
  </script>

</body>

</html>