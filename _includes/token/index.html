<!-- US Geo-restriction Modal -->
<div id="geoRestrictionModal" class="transaction-modal">
  <div class="popup" style="height: auto; padding: 40px 30px;">
    <div class="popup-header" style="margin-bottom: 8px;">
      <h2>Regional Access Restricted</h2>
    </div>
    <div style="text-align: center; margin-bottom: 30px;">
           <p style="font-size: 18px; line-height: 1.5; margin-bottom: 50px;">
        The Diode Utility Token is liquid on the <a href="https://moonscan.io/token/0x434116a99619f2B465A137199C38c1Aab0353913" target="_blank">Moonbeam Network</a> and can be swapped on <a href="https://app.stellaswap.com/exchange/swap?inputCurrency=0x434116a99619f2B465A137199C38c1Aab0353913&outputCurrency=0xFFfffffF7D2B0B761Af01Ca8e25242976ac0aD7D" target="_blank">Stellaswap</a><br><br>
        <a href="{{ '/token/circulatingsupply/' | relative_url }}" target="_blank">Currently Circulating Supply</a>
        <br><br>
        Please connect with Diode directly for additional information about the <a href="https://diode.foundation/docs/token.html" target="_blank">Diode Token</a> and the <a href="https://diode.foundation/docs/programs/disrupt_nft.html" target="_blank">Disrupt NFT</a>.
      </p>
      <div style="display: flex; justify-content: center; gap: 15px;">
        <button class="modal-back-btn" style="margin-top: 0;">Back</button>
        <a href="https://diode.io/joinzone/#1MQKGI_TUYpNksoAAK6TSynBPpviy5MPgDRyTiO7YuGh5_H5sHDN9VIB1diC" target="_blank" style="display: inline-block;">
          <button class="modal-close-btn" style="margin-top: 0;">Contact Diode</button>
        </a>
      </div>
    </div>
  </div>
</div>

<div class="token-page">
    <div class="nft-container">
      The Diode Utility Token is liquid on the <a href="https://moonscan.io/token/0x434116a99619f2B465A137199C38c1Aab0353913" target="_blank">Moonbeam Network</a> and can be swapped on <a href="https://app.stellaswap.com/exchange/swap?inputCurrency=0x434116a99619f2B465A137199C38c1Aab0353913&outputCurrency=0xFFfffffF7D2B0B761Af01Ca8e25242976ac0aD7D" target="_blank">Stellaswap</a><br><br>
      <a href="{{ '/token/circulatingsupply/' | relative_url }}" target="_blank">Currently Circulating Supply</a>
      <br><br>
      Please connect with Diode directly for additional information about the <a href="https://diode.foundation/docs/token.html" target="_blank">Diode Token</a> and the <a href="https://diode.foundation/docs/programs/disrupt_nft.html" target="_blank">Disrupt NFT</a>.
    </div>
  
    <div class="nft-container">
      <h2>Disrupt NFT Limited Edition <span class="info-icon" title="Revenue-generating NFTs with quarterly yield distribution"></span></h2>
      <img class="nft" src="{{ '/assets/images/disrupt_nft.png' | relative_url }}" alt="Disrupt NFT" />
      <ul class="dotted-list">
        <li>• REVENUE-ANCHORED QUARTERLY YIELD</li>
        <li>• EACH NFT REDEEMABLE FOR 20 DIODE</li>
        <li>• <a href="{{ 'https://diode.foundation/docs/programs/disrupt_nft.html' | relative_url }}" target="_blank">READ DETAILS HERE</a></li>
      </ul>
      <div class="nft-number"><strong id="nft-number-display">NFT #-</strong> <span id="nft-range-display" style="display: none;">- #-</span></div>
  
      <div class="quantity-input">
        <label for="quantity">QUANTITY
          <input type="number" id="quantity" value="1" min="1" max="1000" class="always-show-arrows" />
        </label>
      </div>
      <div class="total"><strong>TOTAL:</strong> $0.00 USDC</div>
  
      <div class="terms-container">
        <label class="terms-label"><input type="checkbox" /> I ACCEPT THE <a href="https://diode.foundation/docs/programs/disrupt_nft.html#terms" target="_blank" class="terms-link">TERMS</a></label>
      </div>
      <button class="purchase-btn" disabled>Purchase</button>
      <div class="purchase-disclaimer" hidden>
        <strong>DISCLAIMER:</strong> Purchasing Non-Fungible Tokens (NFTs) is highly speculative and carries significant risks. The value of an NFT may fluctuate or become worthless, and you may lose your entire purchase value. By purchasing, you assume all risks, including financial, legal, and regulatory risks, and acknowledge that the Diode Foundation makes no guarantees about the NFT’s value or future marketability. This offering is intended to comply with U.S. securities laws, including Regulation D exemptions, and is limited to eligible investors. Consult financial, legal, and tax advisors before purchasing. All sales are final, with no refunds unless stated otherwise.
      </div>
    </div>
  
    <div class="your-nfts">
      <div class="table-header" style="background-color: #FAFAFA; padding: 10px 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3 class="table-title">YOUR NFTS</h3>
        </div>
        <hr style="border: 0.3px solid #E6E6E6; margin: 8px 0;">
        <div class="table-box" style="overflow-y: auto; overflow-x: auto; max-height: 400px;">
          <table class="table">
            <thead>
              <tr><th>NFT</th><th>QUANTITY</th></tr>
            </thead>
            <tbody>
             
              <tr><td> Diode Disrupt</td><td>-</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
</div>

<!-- Transaction Modals -->
<div id="confirmingModal" class="transaction-modal">
  <div class="popup">
    <button class="close-btn">×</button>
    <div class="popup-header">
      <h2>Disrupt NFT Limited Edition <span class="info-icon" title="Revenue-generating NFTs with quarterly yield distribution"></span></h2>
    </div>
    <div class="popup-image">
      <img class="nft" src="{{ '/assets/images/disrupt_nft.png' | relative_url }}" alt="NFT Artwork">
    </div>
    <div class="popup-title">NFT #1</div>
    <div class="popup-info" style="font-weight: 300;">Confirming Purchase</div>
    <div class="popup-spinner">
      <img src="{{ '/assets/images/icons/sync.png' | relative_url }}" alt="Processing" class="spinner">
    </div>
  </div>
</div>

<div id="successModal" class="transaction-modal">
  <div class="popup">
    <button class="close-btn">×</button>
    <div class="popup-header" style="margin-bottom: 23px;">
      <h2>Disrupt NFT Limited Edition <span class="info-icon" title="Revenue-generating NFTs with quarterly yield distribution"></span></h2>
    </div>
    <div class="popup-image" style="margin: 0 0 15px;">
      <img class="nft" src="{{ '/assets/images/disrupt_nft.png' | relative_url }}" alt="NFT Artwork">
    </div>
    <div class="popup-status" style="margin: 0;">Success!</div>
    <div class="popup-info" style="margin-top: 10px;">You are the owner of Disrupt NFT #1!</div>
    <div style="margin-top: 32px;">
      <button class="modal-close-btn" style="margin-top: 0;">CLOSE</button>
    </div>
  </div>
</div>

<div id="failureModal" class="transaction-modal">
  <div class="popup" style="height: 630px;">
    <button class="close-btn">×</button>
    <div class="popup-header" style="margin-bottom: 23px;">
      <h2>Disrupt NFT Limited Edition <span class="info-icon" title="Revenue-generating NFTs with quarterly yield distribution"></span></h2>
    </div>
    <div class="popup-image" style="margin: 0 0 15px;">
      <img class="nft" src="{{ '/assets/images/disrupt_nft.png' | relative_url }}" alt="NFT Artwork">
    </div>
    <div class="popup-status" style="margin: 0;">Transaction Failed!</div>
    <div class="popup-info" style="margin-top: 10px;">It looks like those NFTs are no longer available. please try again with a new range.</div>
    <div style="margin-top: 32px;">
      <button class="modal-close-btn" style="margin-top: 0;">CLOSE</button>
    </div>
  </div>
</div>

<!-- CSS -->
<style>
  .token-page {
    font-family: 'Poppins', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem;
    background-color: #FFFFFF;
  }
  
  .countdown {
    border: 1px solid #D73E53;
    height: 132px;
    padding: 15px;
    border-radius: 12px;
    text-align: center;
    margin-bottom: 50px;
    width: 345px;
    max-width: 420px;
    box-shadow: 0 4px 12px rgba(183, 92, 115, 0.08);
  }
  
  .countdown-title {
  font-size: 20px;
  font-weight: 600;
  background: linear-gradient(
    to right, 
    #D73E53 0%, 
    #eb8e9e 10%,
    #A04992 20%,
    #615BA8 30%,
    #A04992 40%,
    #eb8e9e 50%,
    #D73E53 60%,
    #eb8e9e 70%,
    #A04992 80%,
    #615BA8 90%,
    #D73E53 100%
  );
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-size: 200% auto;
  animation: shine 3s linear infinite;
  display: inline-block;
}

@keyframes shine {
  to {
    background-position: 200% center;
  }
}
  
  .countdown-timer {
    display: flex;
    justify-content: space-around;
    margin: 0.5rem 0;
  }
  
  .countdown-unit {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .countdown-unit strong {
    background: linear-gradient(to right, #D73E53 0%, #A04992 48%, #615BA8 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    color: transparent;
    font-size: 32px;
    font-weight: 700;
    display: block;
    margin-top: 23px;
  }
  
  .countdown-unit span {
    color: #141414;
    font-size: 14px;
    font-weight: 600;
    display: block;
  }
  .countdown-complete {
  font-size: 26px;
  font-weight: 700;
  background: linear-gradient(
    to right, 
    #D73E53 0%, 
    #eb8e9e 10%,
    #A04992 20%,
    #615BA8 30%,
    #A04992 40%,
    #eb8e9e 50%,
    #D73E53 60%,
    #eb8e9e 70%,
    #A04992 80%,
    #615BA8 90%,
    #D73E53 100%
  );
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  background-size: 200% auto;
  animation: shine 3s linear infinite;
  display: inline-block;
  padding: 35px 0;
  margin: 0 auto;
  text-align: center;
  width: 100%;
}
  

  img.nft {
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);
    border-radius: 10px;
  }

  .nft-container {
    border: 1px solid #D73E53;
    padding: 26px 30px;
    border-radius: 15px;
    width: 450px;
    text-align: center;
    margin-bottom: 50px;
    box-shadow: 0 5px 15px rgba(183, 92, 115, 0.1);
    font-family: 'Poppins', sans-serif;
  }
  
  .nft-container img {
    width: 400px;
    height: 400px;
    margin-bottom: 1.2rem;
    object-fit: cover;
  }
  
  .nft-container h2 {
    font-size: 20px;
    color: #151515;
    line-height: 150%;
    margin-bottom: 23px;
    font-weight: 600;
    font-family: 'Poppins', sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .help-icon {
    width: 16px !important;
    height: 16px !important;
    margin-bottom: 0rem !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    background: none !important;
    object-fit: contain;
  }
  
  .nft-container ul {
    list-style-type: none;
    padding: 0;
    font-size: 0.95rem;
    color: #333;
    margin-bottom: 24px;
    font-weight: 500;
  }
  
  .nft-container .dotted-list li {
    color: #141414;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 8px;
    text-align: center;
    padding-left: 0;
  }
  
  .nft-container ul a {
    color: #D73E53;
    text-decoration: none;
    font-weight: 500;
  }
  
  .nft-number {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 19px;
  }
  
  .quantity-input {
    margin-bottom: 27px;
    font-weight: 700;
    font-size: 20px;
    position: relative;
  }
  
  .nft-container input[type="number"] {
    width: 80px;
    height: 40px;
    padding: 8px;
    font-size: 1rem;
    margin-left: 0.5rem;
    border: 2px solid #b75c73;
    border-radius: 12px;
    text-align: center;
  }
  
  .nft-container input[type="number"].always-show-arrows {
    -webkit-appearance: none;
    -moz-appearance: textfield;
  }
  
  .nft-container .total {
    margin: 1.2rem 0;
    font-size: 1.2rem;
    font-weight: normal;
  }
  
  .nft-container .total strong {
    font-weight: 700;
  }
  
  .terms-container {
    margin: 1.5rem 0;
  }
  
  .terms-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
  }
  
  .nft-container input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #D73E53 !important;
    border: 1px solid #D73E53 !important;
    cursor: pointer;
  }
  
  .purchase-btn {
    padding: 12px;
    width: 168px;
    height: 56px;
    background: linear-gradient(to right, #D73E53 0%, #A04992 48%, #615BA8 100%);
    border: none;
    border-radius: 10px;
    color: #FAFAFA;
    font-size: 20px;
    cursor: pointer;
    font-weight: 600;
  }
  
  .purchase-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .purchase-disclaimer {
    padding: 20px;
  }

  .purchase-disclaimer:hidden {
    visibility: hidden;
  }
    
  .helper-text {
    font-size: 0.8rem;
    margin-top: 1.2rem;
    color: #c1517e;
    line-height: 1.4;
    max-width: 90%;
    margin-left: auto;
    margin-right: auto;
  }
  
  .your-nfts {
    width: 100%;
    background-color: #FAFAFA;
    padding: 20px;
    max-width: 420px;
    text-align: left;
    border: 1px solid #D73E53;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(183, 92, 115, 0.08);
  }
  
  .your-nfts .table-title {
    font-size: 16px;
    margin: 0px;
    color: #141414;
    font-weight: 500;
    text-transform: uppercase;
  }
  
  .your-nfts .table {
    width: 100%;
    background-color: #FAFAFA;
    border-collapse: separate;
    border-spacing: 0 8px;
    margin-top: 10px;
    text-align: left;
  }
  
  .your-nfts .table th {
    font-size: 12px;
    color: #141414;
    font-weight: 600;
    text-transform: uppercase;
    padding: 4px 7px;
    text-align: left;
    white-space: nowrap;
    height: 32px;
  }
  
  .your-nfts .table td {
    font-size: 12px;
    color: #5E5E5E;
    font-weight: 400;
    padding: 4px 7px;
    background-color: #ffffff;
    text-align: left;
    align-items: flex-start;
    height: 32px;
    margin-bottom: 6px;
    word-wrap: none;
    white-space: nowrap;
  }
  
  .transaction-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    align-items: center;
    justify-content: center;
    overflow: auto;
  }
  
  body.modal-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
  }
  
  .modal-content {
    background-color: #ffffff;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    max-width: 400px;
    width: 90%;
  }
  
  .popup {
    width: 447px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    font-family: 'Poppins', sans-serif;
    text-align: center;
    padding: 40px;
    position: relative;
    display: flex;
    flex-direction: column;
  }
  
  .popup-header {
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 20px;
    color: #111;
  }
  
  .close-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: none;
    border: none;
    font-size: 34px;
    cursor: pointer;
    color: #D73E53;
    z-index: 10;
  }
  
  .popup-image img {
    width: 254px;
  }
  
  .popup-title {
    font-size: 32px;
    font-weight: 700;
    margin: 20px 0 10px;
    color: #141414;
  }
  
  .popup-info {
    font-size: 20px;
    text-transform: uppercase;
    font-weight: 400;
    color: #141414;
    margin-top: 15px !important;
    white-space: pre-line;
  }
  
  .popup-status {
    font-size: 32px;
    text-transform: uppercase;
    color: #141414;
    text-transform: uppercase;
    line-height: 150%;
    font-weight: 700;
    margin-top: 15px;
  }
  
  .popup-spinner {
    display: flex;
    justify-content: center;
    margin: 15px 0;
  }
  
  .spinner {
    animation: spin 1.5s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .modal-icon {
    margin-bottom: 20px;
  }
  
  .modal-icon img {
    width: 60px;
    height: 60px;
  }
  
  .success-icon img {
    filter: drop-shadow(0 4px 8px rgba(0, 200, 0, 0.3));
  }
  
  .failure-icon img {
    filter: drop-shadow(0 4px 8px rgba(255, 0, 0, 0.3));
  }
  
  .modal-content h3 {
    margin-top: 0;
    color: #333;
    font-size: 22px;
  }
  
  .modal-content p {
    color: #666;
    margin-bottom: 25px;
  }
  
  .modal-close-btn,
  .try-again-btn,
  .modal-back-btn {
    padding: 10px 24px;
    background: linear-gradient(to right, #D73E53 0%, #A04992 48%, #615BA8 100%);
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    width: 157px;
    height: 56px;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 32px;
  }
  
  .modal-back-btn {
    background: #000000;
  }
  
  .modal-close-btn:hover,
  .try-again-btn:hover,
  .modal-back-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(95, 87, 230, 0.3);
  }

  .terms-link {
    color: #D73E53;
    text-decoration: none;
    font-weight: 500;
  }
  
  .terms-link:hover {
    text-decoration: underline;
  }

  /* Responsive Styles */
  @media screen and (max-width: 768px) {
    .token-page {
      padding: 1rem;
    }
    
    .countdown {
      width: 100%;
      max-width: 345px;
      padding: 12px;
      height: auto;
    }
    
    .nft-container {
      width: 100%;
      max-width: 345px;
      padding: 20px;
    }
    
    .nft-container img {
      width: 220px;
      height: 220px;
    }
    
    .nft-container h2 {
      font-size: 18px;
      margin-bottom: 16px;
    }
    
    .nft-number {
      font-size: 26px;
      margin-bottom: 15px;
    }
    
    .your-nfts {
      max-width: 345px;
    }
    
    .popup {
      width: 90%;
      max-width: 345px;
      height: auto;
      padding: 25px 15px;
    }
    
    .popup-header h2 {
      font-size: 16px;
    }
    
    .popup-image img {
      width: 200px;
    }
    
    .popup-title {
      font-size: 24px;
    }
    
    .popup-status {
      font-size: 24px;
    }
    
    .popup-info {
      font-size: 16px;
    }
    
    .modal-close-btn,
    .modal-back-btn {
      width: 140px;
      height: 48px;
    }
    
  
    .countdown-unit strong {
      font-size: 28px;
    }
    
    .countdown-unit span {
      font-size: 12px;
    }
    
    .table-box {
      overflow-x: auto;
    }
    
    .your-nfts .table {
      min-width: 300px;
    }
  }
  
  @media screen and (max-width: 480px) {
    .countdown {
      max-width: 300px;
    }
    
    .countdown-title {
      font-size: 18px;
    }
    
    .countdown-unit strong {
      font-size: 24px;
      margin-top: 18px;
    }
    
    .countdown-unit span {
      font-size: 11px;
    }
    
    .nft-container {
      max-width: 300px;
    }
    
    .nft-container h2 {
      font-size: 16px;
    }
    
    .nft-container img {
      width: 180px;
      height: 180px;
    }
    
    .nft-number {
      font-size: 22px;
    }
    
    .your-nfts {
      max-width: 300px;
    }
    
    .popup {
      max-width: 300px;
      padding: 20px 10px;
    }
    
    .popup-title {
      font-size: 20px;
    }
    
    .popup-status {
      font-size: 20px;
    }
    
    .popup-info {
      font-size: 14px;
    }
    
    .modal-close-btn,
    .modal-back-btn {
      font-size: 14px;
      width: 120px;
    }
  }
</style>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', async function() {
    const quantityInput = document.getElementById('quantity');
    const totalDiv = document.querySelector('.total');
    const termsCheckbox = document.querySelector('.terms-container input[type="checkbox"]');
    const purchaseBtn = document.querySelector('.purchase-btn');
    const purchaseDisclaimer = document.querySelector('.purchase-disclaimer');
    const confirmingModal = document.getElementById('confirmingModal');
    const successModal = document.getElementById('successModal');
    const failureModal = document.getElementById('failureModal');
    const geoRestrictionModal = document.getElementById('geoRestrictionModal');
    const nftNumberDisplay = document.getElementById('nft-number-display');
    const nftRangeDisplay = document.getElementById('nft-range-display');
    
    const gotoPointsBtn = document.querySelector('.read-more');
    if (gotoPointsBtn) {
      gotoPointsBtn.addEventListener('click', () => {
        window.location.href = "{{ '/app/' | relative_url }}"
      });
    }
    
    let currentSlotId = 0;
    
    quantityInput.addEventListener('input', function() {
      updateTotal();
      updateNftNumber();
    });
    
    termsCheckbox.addEventListener('change', function() {
      purchaseBtn.disabled = !(termsCheckbox.checked && currentSlotId);
      purchaseDisclaimer.hidden = !(termsCheckbox.checked && currentSlotId);
    });

    updateTotal();
    updateNftNumber();
    
    function calculatePrice(slotId) {
      // $10 base + ($0.02 * (id - 1)) increment per slot
      return (15e6 + (slotId - 1) * 0.02e6) / 1e6;
    }
    
    function updateTotal() {
      if (currentSlotId != 0) {
        const quantity = parseInt(quantityInput.value) || 1;
        if (quantity <= 0) {
          quantityInput.value = 1;
          updateTotal();
          return;
        }
        
        let total = 0;
        for (let i = 0; i < quantity; i++) {
          const slotId = currentSlotId + i;
          total += calculatePrice(slotId);
        }
        
        totalDiv.innerHTML = `<strong>TOTAL:</strong> $${total.toFixed(2)} USDC`;
      } else {
        totalDiv.innerHTML = `<strong>TOTAL:</strong> $- USDC`;
      }
    }
    
    function updateNftNumber() {
      const quantity = parseInt(quantityInput.value) || 0;
      if (quantity <= 0) {
        nftNumberDisplay.textContent = `NFT #${currentSlotId}`;
        nftRangeDisplay.style.display = 'none';
      } else if (quantity === 1) {
        if (currentSlotId != 0) { // 0 would mean currentSlotID isn't yet initialized
          nftNumberDisplay.textContent = `NFT #${currentSlotId}`;
          nftRangeDisplay.style.display = 'none';
        }
      } else {
        nftNumberDisplay.textContent = `NFT #${currentSlotId}`;
        nftRangeDisplay.textContent = `- #${currentSlotId + quantity - 1}`;
        nftRangeDisplay.style.display = 'inline';
      }
      
      updateModalNftNumbers(quantity);
    }
    
    function updateModalNftNumbers(quantity) {
      const confirmingTitle = confirmingModal.querySelector('.popup-title');
      let titleContent;

      if (confirmingTitle) {
        confirmingTitle.textContent = quantity === 1 ? 
          `NFT #${currentSlotId}` : 
          `NFT #${currentSlotId} - #${currentSlotId + quantity - 1}`;
      }
      
      const successInfo = successModal.querySelector('.popup-info');
      if (successInfo) {
        const nftRange = quantity === 1 ? 
          `Disrupt NFT #${currentSlotId}` : 
          `Disrupt NFT #${currentSlotId} - #${currentSlotId + quantity - 1}`;
        successInfo.textContent = `You are the owner of ${nftRange}!`;
      }
      
      const failureInfo = failureModal.querySelector('.popup-info');
      if (failureInfo) {
        failureInfo.textContent = 'It looks like those NFTs are no longer available. Please try again with a new range.';
      }
    }
    
    purchaseBtn.addEventListener('click', async function() {
      if (!termsCheckbox.checked) {
        alert('Please accept the terms to continue.');
        return;
      }
      
      if (typeof window.ethereum === 'undefined') {
        alert('MetaMask is not installed. Please install MetaMask to make a purchase.');
        return;
      }
      
      if (typeof Web3 === 'undefined') {
        alert('Web3 library is not loaded. Please refresh the page or check your internet connection.');
        return;
      }
      
      try {
        confirmingModal.style.display = 'flex';
        const contractData = await initializeContract();
        if (!contractData) {
          throw new Error('Failed to initialize contract. Check console for details.');
        }
        
        const { web3, contract, usdcContract } = contractData;
        
        const accounts = await window.ethereum.request({ 
          method: 'eth_requestAccounts' 
        });
        const account = accounts[0];
        
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (chainId !== '0x504') { // Moonbeam mainnet
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x504' }],
          });
        }
        
        // Check slot availability
        const slotResult = await contract.methods.getNextSlot().call();
        const slotId = Number(slotResult.slotId);
        const slotPrice = Number(slotResult.priceUSDC);
        
        if (slotId === 0) {
          throw new Error('All NFTs are sold out');
        }
        
        const quantity = parseInt(quantityInput.value) || 1;
        
        // Calculate total price
        let totalPrice = 0;
        const slotIds = [];
        
        for (let i = 0; i < quantity; i++) {
          const currentId = slotId + i;
          if (currentId > 8500) {
            throw new Error('Maximum slot ID is 8500');
          }
          slotIds.push(currentId);
          // Calculate total price using the formula: 0.01e6 + (id - 1) * 2e4
          totalPrice += (15e6 + (currentId - 1) * 0.02e6);
        }
        
        // Check USDC balance
        const usdcBalance = await usdcContract.methods.balanceOf(account).call();
        if (Number(usdcBalance) < totalPrice) {
          throw new Error(`You need at least $${totalPrice/1e6} USDC.wh.\n\nYou can get USDC.wh (on Moonbeam) at https://portalbridge.com/.\n\n`);
        }
        
        // Approve USDC
        const approveTx = await usdcContract.methods.approve(
          contract.options.address, 
          totalPrice
        ).send({ from: account });
        
        // Buy the slots
        const buyTx = await contract.methods.buySlots(slotIds).send({ from: account });
        
        confirmingModal.style.display = 'none';
        successModal.style.display = 'flex';
        
        // Update the success modal with transaction details
        const successInfo = successModal.querySelector('.popup-info');
        successInfo.innerHTML = quantity === 1 ?
          `You are the owner of Disrupt NFT #${slotId}!<br>
          <a href="https://moonscan.io/tx/${buyTx.transactionHash}" target="_blank" 
             style="color: #D73E53; margin-top: 10px; display: inline-block; text-decoration: none;">
            View on Moonscan
          </a>` :
          `You are the owner of Disrupt NFT #${slotId} - #${slotId + quantity - 1}!<br>
          <a href="https://moonscan.io/tx/${buyTx.transactionHash}" target="_blank" 
             style="color: #D73E53; margin-top: 10px; display: inline-block; text-decoration: none;">
            View on Moonscan
          </a>`;
        
        await fetchNFTData();
        
      } catch (error) {
        console.error('Purchase transaction error:', error);
        confirmingModal.style.display = 'none';
        
        const failureInfo = failureModal.querySelector('.popup-info');
        failureInfo.textContent = error.message || 'Transaction failed. Please try again.';
        failureModal.style.display = 'flex';
      }
    });

    const closeButtons = document.querySelectorAll('.close-btn');
    closeButtons.forEach(button => {
      button.addEventListener('click', function() {
        confirmingModal.style.display = 'none';
        successModal.style.display = 'none';
        failureModal.style.display = 'none';
      });
    });
    
    const modalCloseButtons = document.querySelectorAll('.modal-close-btn');
    modalCloseButtons.forEach(button => {
      button.addEventListener('click', function() {
        confirmingModal.style.display = 'none';
        successModal.style.display = 'none';
        failureModal.style.display = 'none';
        checkSlotAvailability();
      });
    });
    
    document.querySelector('.try-again-btn')?.addEventListener('click', function() {
      failureModal.style.display = 'none';
      purchaseBtn.click();
    });
    
    const modalBackBtn = document.querySelector('.modal-back-btn');
    if (modalBackBtn) {
      modalBackBtn.addEventListener('click', function() {
        document.body.classList.remove('modal-open');
        window.history.back();
      });
    }
    
    function simulateTransaction() {
      return new Promise((resolve) => {
        setTimeout(() => {
          const success = Math.random() > 0.2;
          resolve({ success });
        }, 2000);
      });
    }
    
    window.addEventListener('click', function(event) {
      if (event.target === successModal) {
        successModal.style.display = 'none';
      }
      if (event.target === failureModal) {
        failureModal.style.display = 'none';
      }
    });

    // NFT Fetching
    async function fetchNFTData() {
      try {
        const moonbeamRPC = "https://rpc.api.moonbeam.network";
        let walletAddress = null;
        
        if (typeof window.ethereum !== 'undefined') {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' }).catch(() => []);
          if (accounts && accounts.length > 0) {
            walletAddress = accounts[0];
          }
        }
        
        if (!walletAddress) {
          const nftTableBody = document.querySelector('.your-nfts .table tbody');
          if (nftTableBody) {
            nftTableBody.innerHTML = '<tr><td colspan="2">Connect wallet to view your NFTs</td></tr>';
          }
          return;
        }

        const NFT_BOOSTS = [
          {
            contractAddress: "0xe9a4aeDD9B50c0394Efc83332E98B6eB977f5ae7",
            name: "Diode Disrupt",
            baseBoost: 0
          }
        ];

        const web3 = new Web3(new Web3.providers.HttpProvider(moonbeamRPC));

        const nftBalances = await Promise.all(NFT_BOOSTS.map(async (nft) => {
          try {
            const contract = new web3.eth.Contract([
              {
                "inputs": [
                  {"internalType": "address[]", "name": "accounts", "type": "address[]"},
                  {"internalType": "uint256[]", "name": "ids", "type": "uint256[]"}
                ],
                "name": "balanceOfBatch",
                "outputs": [{"internalType": "uint256[]", "name": "", "type": "uint256[]"}],
                "stateMutability": "view",
                "type": "function"
              }
            ], nft.contractAddress);
            
            const tokenIds = Array.from({length: 8500}, (_, i) => i + 1);
            const accounts = Array(tokenIds.length).fill(walletAddress);
            
            const balances = await contract.methods.balanceOfBatch(accounts, tokenIds).call();
            
            const balance = balances.reduce((sum, val) => sum + parseInt(val), 0);
            
            return {
              name: nft.name,
              balance: balance,
              baseBoost: nft.baseBoost,
              contractAddress: nft.contractAddress
            };
          } catch (err) {
            console.error("Failed to fetch NFT balance:", err);
            return {
              name: nft.name,
              balance: 0,
              baseBoost: nft.baseBoost,
              contractAddress: nft.contractAddress
            };
          }
        })).catch(err => {
          console.error("Failed to fetch NFTs", err);
          return [];
        });

        const userNfts = nftBalances.filter(item => item.balance > 0);
        
        const nftTableBody = document.querySelector('.your-nfts .table tbody');
        if (nftTableBody) {
          if (userNfts.length > 0) {
            nftTableBody.innerHTML = '';
            userNfts.forEach(nft => {
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${nft.name}</td><td>${nft.balance}</td>`;
              nftTableBody.appendChild(tr);
            });
          } else {
            nftTableBody.innerHTML = '<tr><td colspan="2">No NFTs Found</td></tr>';
          }
        }
      } catch (error) {
        console.error('Error fetching NFT data:', error);
        const nftTableBody = document.querySelector('.your-nfts .table tbody');
        if (nftTableBody) {
          nftTableBody.innerHTML = '<tr><td colspan="2">Error loading NFTs</td></tr>';
        }
      }
    }

    // NFT Contract interaction
    async function initializeContract() {
      try {
        const contractDataUrl = "{{ '/assets/contracts/contract_data.json' | relative_url }}";
        const abiUrl = "{{ '/assets/contracts/slotmarket_abi.json' | relative_url }}";
        const moonbeamRPC = "https://rpc.api.moonbeam.network";
        
        let contractData, abi;
        
        try {
          const contractResponse = await fetch(contractDataUrl);
          if (!contractResponse.ok) {
            console.warn(`Failed to fetch contract data from ${contractDataUrl}. Status: ${contractResponse.status}`);
            contractData = { "contract_address": "0xe9a4aeDD9B50c0394Efc83332E98B6eB977f5ae7" };
          } else {
            contractData = await contractResponse.json();
          }
          
          // fetch ABI
          const abiResponse = await fetch(abiUrl);
          if (!abiResponse.ok) {
            console.warn(`Failed to fetch ABI from ${abiUrl}. Status: ${abiResponse.status}`);
            throw new Error('Contract interface definition not available');
          } else {
            abi = await abiResponse.json();
          }
        } catch (fetchErr) {
          console.error('Error fetching contract files:', fetchErr);
          throw new Error('Failed to load contract information. Please try again later.');
        }
        
        let web3;
        let isReadOnly = false;
        
        if (typeof window.ethereum !== 'undefined') {
          web3 = new Web3(window.ethereum);
        } else {
          web3 = new Web3(new Web3.providers.HttpProvider(moonbeamRPC));
          isReadOnly = true;
          console.log('Using read-only web3 provider (MetaMask not detected)');
        }
        
        const contractAddress = contractData.contract_address;
        
        return {
          web3,
          isReadOnly,
          contract: new web3.eth.Contract(abi, contractAddress),
          usdcContract: new web3.eth.Contract([
            {
              "constant": true,
              "inputs": [{"name": "account", "type": "address"}],
              "name": "balanceOf",
              "outputs": [{"name": "", "type": "uint256"}],
              "type": "function"
            },
            {
              "constant": false,
              "inputs": [
                {"name": "spender", "type": "address"},
                {"name": "amount", "type": "uint256"}
              ],
              "name": "approve",
              "outputs": [{"name": "", "type": "bool"}],
              "type": "function"
            }
          ], "0x931715FEE2d06333043d11F658C8CE934aC61D0c")
        };
      } catch (error) {
        console.error('Contract initialization error:', error);
        return null;
      }
    }
    
    async function switchToMoonbeamNetwork() {
      if (typeof window.ethereum !== 'undefined') {
        try {
          const chainId = await window.ethereum.request({ method: 'eth_chainId' });
          if (chainId !== '0x504') { // Moonbeam mainnet
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x504' }],
            }).catch(async (switchError) => {
              if (switchError.code === 4902) {
                await window.ethereum.request({
                  method: 'wallet_addEthereumChain',
                  params: [{
                    chainId: '0x504',
                    chainName: 'Moonbeam',
                    nativeCurrency: {
                      name: 'GLMR',
                      symbol: 'GLMR',
                      decimals: 18
                    },
                    rpcUrls: ['https://rpc.api.moonbeam.network'],
                    blockExplorerUrls: ['https://moonscan.io']
                  }]
                });
              } else {
                console.error('Failed to switch network:', switchError);
              }
            });
            console.log('Switched to Moonbeam network');
          } else {
            console.log('Already on Moonbeam network');
          }
        } catch (error) {
          console.error('Error switching to Moonbeam network:', error);
        }
      }
    }

    async function checkSlotAvailability() {
      try {
        const contractData = await initializeContract();
        if (!contractData) {
          console.error('Failed to initialize contract for slot availability check');
          return;
        }
        
        const { contract } = contractData;
        try {
          const result = await contract.methods.getNextSlot().call();
          const slotId = Number(result.slotId);
          const priceUSDC = Number(result.priceUSDC) / 1e6;
          if (slotId === 0) {
            document.querySelector('.nft-number').innerText = 'All slots sold!';
            purchaseBtn.disabled = true;
            purchaseDisclaimer.hidden = true;
          } else {
            currentSlotId = slotId;            
            document.getElementById('nft-number-display').textContent = `NFT #${slotId}`;
            const quantity = parseInt(quantityInput.value) || 1;
            updateTotal();
            updateNftNumber();

            purchaseBtn.disabled = !(termsCheckbox.checked && typeof window.ethereum !== 'undefined');
            purchaseDisclaimer.hidden = !(termsCheckbox.checked && typeof window.ethereum !== 'undefined');

            if (typeof window.ethereum === 'undefined') {
              const helperText = document.createElement('div');
              helperText.className = 'helper-text';
              helperText.textContent = 'MetaMask extension is required for purchasing. Please install MetaMask to continue.';
              
              if (!document.querySelector('.helper-text')) {
                document.querySelector('.purchase-btn').insertAdjacentElement('afterend', helperText);
              }
            }
          }
        } catch (error) {
          console.error('Failed to check slot availability:', error);
        }
      } catch (error) {
        console.error('Failed to check slot availability:', error);
      }
    }

    async function checkGeoRestriction() {
      try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        const siteBaseUrl = "{{ site.baseurl | escape }}";

        console.log('BASE: ',siteBaseUrl);
        if (siteBaseUrl != '/diodenetwork-dev-2025' && data.country === 'US') { 
          geoRestrictionModal.style.display = 'flex';
          document.body.classList.add('modal-open');
          
          geoRestrictionModal.addEventListener('click', function(event) {
            if (event.target === geoRestrictionModal) {
              event.stopPropagation();
              return false;
            }
          });
        }
      } catch (error) {
        console.error('Failed to check geolocation:', error);
      }
    }

    fetchNFTData();
    await switchToMoonbeamNetwork();
    checkSlotAvailability();
    checkGeoRestriction();
  });
</script>

<!-- Add countdown script reference -->
<script src="{{ '/assets/js/countdown.js' | relative_url }}"></script>
