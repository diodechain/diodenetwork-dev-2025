<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diode Network Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #ffffff;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    .dashboard {
      max-width: 1392px;
      margin: 20px auto;
      padding: 0 20px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      gap: 24px;
    }

    .left-column {
      width: 920px;
      margin-bottom: 55px;
      margin-top: 20px;
    }

    .content-box {
      background-color: #FAFAFA;
      padding: 14px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 2px rgba(0, 0, 0, 0.1);
      flex: 1;
    }

    .content-box h3 {
      font-size: 20px;
      font-weight: 500;
      color: #141414;
      margin-top: 0;
    }

    .tables-row {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-top: 24px;
      margin-bottom: 20px;
      background-color: hsl(0, 0%, 100%);
    }

    .table {
      width: 100%;
      background-color: #FAFAFA;
      border-collapse: separate;
      border-spacing: 0 8px;
      margin-top: 10px;
      text-align: left;
    }

    .table tr {
      margin-bottom: 8px;
    }

    .table-box {
      padding: 10px 16px;
      background-color: #FAFAFA;
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
    }

    .table th {
      font-size: 12px;
      color: #141414;
      font-weight: 600;
      text-transform: uppercase;
      padding: 4px 7px;
      text-align: left;
      white-space: nowrap;
      height: 32px;
    }

    .table td {
      font-size: 12px;
      color: #5E5E5E;
      font-weight: 400;
      padding: 4px 7px;
      background-color: #ffffff;
      text-align: left;
      align-items: flex-start;
      height: 32px;  
      margin-bottom: 6px; 
      word-wrap: none;
      white-space: nowrap;
    }

    .clickable-row {
      background-color: #ffffff;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .clickable-row:hover {
      background-color: #e8e9e9 !important;
    }

    .clickable-row td {
      background-color: transparent;
    }

    .table th.address-col {
      width: 120px; 
      max-width: 120px;
    }

    .table th.description-col {
      width: auto;
      min-width: 120px;  
    }

    .table td.description-col {
      white-space: normal;
      word-wrap: break-word;
    }

    .table td.address-col {
      font-family: monospace;
    }

    .table-title {
      font-size: 16px;
      margin: 0px;
      color: #141414;
      font-weight: 500;
      display: flex;
      justify-content: center;
      align-items: center;
      text-transform: uppercase;
    }

    .table-box::-webkit-scrollbar {
      width: 5px;
      max-height: 10px;
    }

    .table-box::-webkit-scrollbar-track {
      background: white;
      max-height: 10px;
    }

    .table-box::-webkit-scrollbar-thumb {
      background: rgb(209, 209, 209);
      border-radius: 10px;
      max-height: 10px;
    }

    .scroller::-webkit-scrollbar-button:start:increment {
      height: 25%;
      display: block;
      background: transparent;
    }

    .button-open-camp {
      background: linear-gradient(to right, #D73E53 0%, #A04992 48%, #615BA8 100%);
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      font-size: 14px;
      height: 44px;
      cursor: pointer;
      border: none;
    }

    .button-view-all {
      background-color: #ffffff;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      color: #000000;
      border: 1px solid #000000;
      padding: 8px 26px;
      border-radius: 5px;
      font-size: 10px;
    }

    .button-view-all:hover {
      background-color: #000000;
      color: #ffffff;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 30px;
      background: linear-gradient(to right, #D73E53 0%, #A04992 48%, #615BA8 100%);
      color: white;
      border-radius: 0px;
      margin-bottom: 30px;
    }

    .dashboard-header .title {
      font-size: 20px;
      font-weight: medium;
    }

    .dashboard-header .buttons {
      display: flex;
      gap: 10px;
    }

    .dashboard-header button {
      padding: 8px 15px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }

    .open-campaign {
      background-color: black;
      font-family: 'Poppins', sans-serif;
      color: white;
    }
    .coin {
      width: 24px;
      height: 24px;
      background-color: gold;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: black;
      margin-left: 8px;
    }

    .container {
      display: flex;
      gap: 20px;
    }

    .card {
      background: #FAFAFA;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #D73E53;
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
    }

    .card-main-title {
      font-size: 16px;
      font-weight: 500;
      color: #141414;
    }

    .card h2 {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .card-number {
      font-size: 32px;
      font-weight: bold;
      color: #151515;
      height: 10px;
    }

    .card-title {
      padding: 20px 16px;
      background-color: #ffffff;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fafafa;
      padding: 20px;
      border-radius: 8px;
      width: 95%;
      max-width: 1400px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      margin: 0;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 500;
      color: #141414;
    }

    .rank-highlight {
      background-color: #D73E53 !important;
      color: #fff !important;
    }

    .close-modal {
      margin-right:30px;
      cursor: pointer;
      font-size: 24px;
      color: #5E5E5E;
    }

    .modal .table td {
      max-width: none;
      white-space: normal;
    }

    .modal .table th {
      max-width: none;
      white-space: normal;
    }

    .modal .table td.address-col {
      white-space: normal;
      font-family: monospace;
      word-break: break-all;
      min-width: 350px;
      max-width: 400px;
    }

    .modal .table td.description-col {
      white-space: normal;
      min-width: 200px;
    }

    @media (max-width: 768px) {
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
      }

      .close-modal {
        margin-right:20px;
      }

      .modal-content {
        width: 95%;
        padding: 2px;
        margin: 0;
        max-height: 90vh;
      }

      .modal-header {
        margin-bottom: 15px;
      }

      .modal-title {
        font-size: 16px;
      }

      .modal .table th,
      .modal .table td {
        padding: 8px;
        font-size: 12px;
      }
    }

    @media (max-width: 480px) {
      .modal-content {
        width: 95%;
        padding: 10px;
      }

      .modal-title {
        font-size: 14px;
      }

      .modal .table th,
      .modal .table td {
        padding: 6px;
        font-size: 11px;
      }

      .modal .table td.address-col {
        min-width: 150px;
        max-width: 200px;
      }

      .close-modal {
        font-size: 20px;
        margin-right: 20px;
      }
    }
    @media (max-width: 992px) {
      .container {
        flex-wrap: wrap;
        gap: 20px;
      }

      .card {
        width: 100%;
      }

      .tables-row {
        flex-direction: column;
      }

      .content-box {
        margin-bottom: 20px;
      }
    }

    @media (max-width: 768px) {
      .dashboard {
        padding: 0 20px;
        overflow-x: hidden;
        margin: 0;
      }

      .dashboard-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
        padding: 20px;
        margin-bottom: 23px;
      }

      .dashboard-header .title {
        text-align: left;
      }

      .dashboard-header .buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-end;
      }

      .dashboard-header button {
        font-size: 12px;
        width: 150px;
        min-height: 34px;
      }

      .rank-container {
        flex-direction: row;
        gap: 12px;
        margin-bottom: 30px;
      }

      .boost-box {
        order: 2;
        margin: 0;
        min-width: 90px;
        margin-top: 20px;
      }

      .rank-box.epoch-rank {
        order: 1;
        min-height: 74px;
        max-width: 94%;
      }

      .rank-container {
        flex-direction: column;
        gap: 12px;
        margin-bottom: 30px;
      }

      .rank-box {
        width: 100% !important;
        min-width: unset;
        height: 73px;
        padding: 0 15px;
      }

      .rank-title {
        font-size: 16px;
      }

      .rank-value {
        font-size: 24px;
      }

      .boost-p-number {
        font-size: 24px;
      }

      .boost-p-text {
        font-size: 12px;
      }

      .card {
        width: 100%;
      }

      .table-title {
        font-size: 14px !important;
      }

      .button-view-all {
        padding: 6px 20px;
      }

    }

    .boosted-indicator {
      display: none;
      font-size: 14px;
      color: #A04992;
      text-align: left;
      margin-top: 2px;
      margin-left: 2px;
    }

    @media (max-width: 480px) {
      .dashboard {
        padding: 0 10px;
      }

      .dashboard-header {
        padding: 15px;
        justify-content: center;
        align-items: center;
        display: flex;
      }

      .dashboard-header .title {
        font-size: 16px;
        width: 100%;
      }

      .address-copy {
        background-color: #1E1E1E;
        height: 43px;
        font-size: 10px;
        justify-content: center;
        align-items: center;
        display: flex;
      }

      .dashboard-header button {
        font-size: 12px;
        width: 150px;
        min-height: 34px;
      }

      .rank-container {
        gap: 10px;
      }

      .rank-box {
        padding: 0 10px;
      }

      .rank-title {
        font-size: 16px;
      }

      .rank-value {
        font-size: 24px;
      }

      .row {
        flex-direction: column;
        gap: 15px;
      }

      .left-column {
        width: 100% !important;
        margin-bottom: 30px;
      }

      .card-number {
        font-size: 28px;
      }

      .table th,
      .table td {
        font-size: 10px;
        padding: 8px;
      }

      .dashboard-header .buttons {
        flex-direction: column;
        width: 100%;
      }
    }

    @keyframes spin {
        0% { transform: rotate(0deg);}
        100% { transform: rotate(360deg);}
    }

    .spinner {
        display: inline-block;
        width: 15px;
        height: 15px;
        border: 3px solid #000;
        border-top: 3px solid #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .spinner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        background-color: rgba(255, 255, 255, 0.5);
        z-index: 1000;
    }

    .tree-points {
      font-size: 12px;
      color: #5E5E5E;
      font-weight: 400;
      margin-left: 10px;
    }

    .points-under-username {
      font-size: 12px;
      display: block;
      margin-left: 0;
      text-align: center;
      width: 100%;
    }

    .child-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 6px;
        padding: 4px 0;
        align-self: flex-start;
    }
    .tree-child-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 6px;
        padding: 4px 0;
        border: 1px solid #A04992;
        border-radius: 6px;
        background-color: #fff;
        color: #000;
    }

    .stats-row {
        display: flex;
        align-items: center;
        margin-left: 10px;
        gap: 10px;
        font-size: 12px;
        margin-bottom: 6px;
        padding: 4px 0;
    }

    .plus-btn {
        background: #A04992;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        width: 28px;
        height: 28px;
        cursor: pointer;
        margin-left: 10px;
        transition: background 0.2s;
    }
    .plus-btn:hover, .tree-plus-btn:hover {
        background: #7a3570;
    }
    .tree-plus-btn {
        font-weight: bold;
        font-size: 18px;
    }

    .children-div {
        position: relative;
        border: 1px solid #A04992;
        border-radius: 6px;
        background-color: #A04992;
        color: #fff;
    }

    .hide-0s-container {
        display: none;
        position: sticky;
        top: 0;
        left: 0;
        z-index: 1000;
    }
  </style>
</head>

<body>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      if (!window.ethereum) {
        window.location.href = "{{ '/wallet/' | relative_url }}";
        return;
      }
      try {
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (!accounts || accounts.length === 0) {
          window.location.href = "{{ '/wallet/' | relative_url }}";
        }
      } catch (err) {
        console.error('Failed to retrieve accounts:', err);
        window.location.href = "{{ '/wallet/' | relative_url }}";
      }
    });
  </script>

  <div class="dashboard">
    <div class="row">
      <div class="col-md-12">
        <h1>Admin Panel</h1>
        <div id="participants-section">
            <h2>Participants</h2>
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="participants-search" placeholder="Type to search..." style="min-width: 220px; display: block;">
            <select id="participants-dropdown" style="min-width: 220px;">
                <option value="">Loading...</option>
            </select>
            </div>
            <button id="get-stats-btn" style="margin-top: 16px; padding: 8px 20px; border-radius: 5px; background: #A04992; color: #fff; border: none; font-size: 14px; cursor: pointer;">
                Get Stats
            </button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <div id="hide-0s-container" class="hide-0s-container">
                <button style="margin-top: 16px; padding: 8px 20px; border-radius: 5px; background: #A04992; color: #fff; border: none; font-size: 14px; cursor: pointer;">
                    Hide 0's
                </button>
            </div>
            <div id="stats-output" style="margin-top: 24px; font-family: 'Poppins', sans-serif; font-size: 15px;">
            </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        function formatAddress(address) {
            if (!address) return '';
            return `${address.slice(0, 3)}…${address.slice(-7)}`;
        }

        if (!window.ethereum) {
            window.location.href = "{{ '/wallet/' | relative_url }}";
            return;
        }

        let accounts;
        try {
            accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (!accounts || accounts.length === 0) {
                window.location.href = "{{ '/wallet/' | relative_url }}";
                return;
            }
        } catch (err) {
            console.error('Failed to retrieve accounts:', err);
            window.location.href = "{{ '/wallet/' | relative_url }}";
            return;
        }

        const walletAddress = (accounts && accounts[0]) ? accounts[0] : null;
        if (!walletAddress) return;

        const baseURL = "https://registrar-prod.diode.link:8008/v1";
        let userRank = '';
        let childrenList = '';

        async function getData(endpoint, wallet_address) {
            try {
                const res = await fetch(`${baseURL}${endpoint}`, {
                    method: "GET",
                    headers: {
                        "Authorization": wallet_address
                    }
                });
                if (!res.ok) {
                    console.warn("Fetch failed:", res.status, res.statusText);
                    return null;
                }
                return await res.json();
            } catch (err) {
                console.error("Error fetching", endpoint, err);
                return null;
            }
        }

        // Load participants
        const participantData = await getData("/users_by_rank", walletAddress);

        if (Array.isArray(participantData)) {
            const dropdown = document.getElementById('participants-dropdown');
            dropdown.innerHTML = '';
            participantData.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant.username;
                option.textContent = participant.username + " (" + participant.rank + ")";
                dropdown.appendChild(option);
            });
        }

        // Search box auto-select
        const searchBox = document.getElementById('participants-search');
        const dropdown = document.getElementById('participants-dropdown');
        if (searchBox && dropdown) {
            searchBox.addEventListener('input', function() {
                const searchValue = searchBox.value.trim().toLowerCase();
                let found = false;
                for (let i = 0; i < dropdown.options.length; i++) {
                const optionText = dropdown.options[i].textContent.toLowerCase();
                const optionValue = dropdown.options[i].value.toLowerCase();
                if (
                    optionText.startsWith(searchValue) ||
                    optionValue.startsWith(searchValue)
                ) {
                    dropdown.selectedIndex = i;
                    found = true;
                    break;
                }
                }
                if (!found) {
                    dropdown.selectedIndex = -1;
                }
            });
        }

        document.getElementById('get-stats-btn').addEventListener('click', async function() {
            // Show a spinning icon while loading
            const btn = document.getElementById('get-stats-btn');
            show_spinner(btn);

            // Get the selected participant from the dropdown
            const dropdown = document.getElementById('participants-dropdown');
            if (!dropdown || dropdown.selectedIndex === -1) {
                alert('Please select a participant.');
                hide_spinner(btn);
                return;
            }
            const selectedUsername = dropdown.value;
            if (!selectedUsername) {
                alert('Please select a participant.');
                hide_spinner(btn);
                return;
            }

            const parentWallet = await getWalletAddress(selectedUsername, walletAddress);

            if (!parentWallet) {
                alert('Could not get wallet!  This person is a no-op!');
                hide_spinner(btn);
                return;
            }

            userRank = await getUserRank(parentWallet);
            if (!userRank) {
                alert('Could not fetch user rank!  This is rare.');
                hide_spinner(btn);
                return;
            }
             
            const hide0sContainer = document.getElementById('hide-0s-container');
            hide0sContainer.addEventListener('click', function() {
                const statsDivs = document.querySelectorAll('.tree-points');
                statsDivs.forEach(div => {
                    if (div.textContent === '0 to parent') {
                        if (div.parentElement.parentElement.getAttribute('descendants') == 0) {
                            div.parentElement.parentElement.style.display = 'none';
                        }
                    }
                });
            });
            hide0sContainer.style.display = 'block';

            const statsOutputDiv = document.getElementById('stats-output');
            statsOutputDiv.innerHTML = "";

            userRank.tree_points_to_parent = 0;
            userRank.username = selectedUsername; 
            const statsDiv = await createChildDiv(userRank, 0);
            statsOutputDiv.appendChild(statsDiv);
            const parentStats = {
                boost_percent: userRank.boost_percent,
                points: userRank.points,
                active_referral_tree: userRank.active_referral_tree
            }
            const childrenDiv = await createChildrenDiv(selectedUsername, parentWallet, parentStats);
            const pointsFromChildrenDiv = document.createElement('div');
            childrenDiv.className = 'children-div';
            statsDiv.appendChild(childrenDiv);
            // Find the total tree points in childrenDiv
            const totaltreePointsDiv = childrenDiv.querySelector('.totaltree-points');
            // Find the fromTreePointsSpan in statsDiv
            const fromTreePointsSpan = statsDiv.querySelector('.from-tree-points');
            if (totaltreePointsDiv && fromTreePointsSpan) {
                console.log(totaltreePointsDiv.textContent);
                console.log(fromTreePointsSpan.textContent);
                // Extract the first number from each element's text
                const totalTreePointsMatch = totaltreePointsDiv.textContent.match(/(\d+)/);
                const fromTreePointsMatch = fromTreePointsSpan.textContent.match(/(\d+)/);
                if (totalTreePointsMatch && fromTreePointsMatch) {
                    const totalTreePoints = parseInt(totalTreePointsMatch[1], 10);
                    const fromTreePoints = parseInt(fromTreePointsMatch[1], 10);
                    if (totalTreePoints > fromTreePoints) {
                        // Create a red alert div
                        const alertDiv = document.createElement('div');
                        alertDiv.textContent = 'Alert: Child tree points exceed parent tree points!';
                        alertDiv.style.color = '#D73E53';
                        alertDiv.style.fontWeight = 'bold';
                        alertDiv.style.marginTop = '8px';
                        statsDiv.appendChild(alertDiv);
                    }
                } else console.log("No numbers found");
            } else {
                console.log("No totaltreePointsDiv or fromTreePointsSpan found");
            }
            addPlusButtonListeners(childrenDiv);

            hide_spinner(btn);
            return;
        });

        async function getWalletAddress(username, walletAddress) {
            try {
                const walletInfo = await getData("/wallet/" + username, walletAddress);
                if (walletInfo && walletInfo.wallet) {
                    return walletInfo.wallet;
                } else {
                    console.warn('No wallet found');
                    return null;
                }
            } catch (err) {
                console.error('Error fetching wallet info:', err);
                return null;
            }
        }

        function loading_spinner() {
            return `<span class="spinner"></span>`;
        }

        function show_spinner(btn) {
            if (!btn.querySelector('.spinner-overlay')) {
                const overlay = document.createElement('span');
                overlay.className = 'spinner-overlay';
                overlay.innerHTML = loading_spinner();
                btn.style.position = 'relative';
                btn.appendChild(overlay);
                btn.disabled = true;
            }
        }

        function hide_spinner(btn) {
            if (btn.querySelector('.spinner-overlay')) {
                btn.removeChild(btn.querySelector('.spinner-overlay'));
                btn.disabled = false;
            }
        }

        async function getUserRank(walletAddress) {
            const userRank = await getData("/user/rank", walletAddress);
            return userRank;
        }

        function addParentStat(parentDiv, stat) {
            const statsDiv = document.createElement('div');
            statsDiv.className = 'stats-row';
            statsDiv.textContent = stat;
            parentDiv.appendChild(statsDiv);
            return statsDiv;
        }


        async function createChildrenDiv(parent_username, parentWallet, parentStats={}) {
            const childrenDiv = document.createElement('div');
            childrenDiv.id = 'children-div-' + parent_username;
            totaltreePointsDiv = addParentStat(childrenDiv, "");
            const boost_pct = parentStats.boost_percent || "?";

            let points_from_children = 0;
            if (!parentWallet) {
                childrenDiv.textContent = 'No wallet found.';
            } else {
                const childrenList = await getData("/tree/list", parentWallet);
                if (Array.isArray(childrenList) && childrenList.length > 0) {
                    childrenList.forEach(async (child, idx) => {
                        points_from_children += child.tree_points_to_parent;
                        const childDiv = await createChildDiv(child, child.descendants > 0);
                        // Collect all child divs with their tree_points_to_parent
                        if (!childrenDiv._childDivs) childrenDiv._childDivs = [];
                        childrenDiv._childDivs.push({ 
                            div: childDiv, 
                            points: typeof child.tree_points_to_parent === 'number' ? child.tree_points_to_parent : (parseInt(child.tree_points_to_parent) || 0)
                        });
                        // If this is the last child, sort and append all
                        if (idx === childrenList.length - 1) {
                            childrenDiv._childDivs
                                .sort((a, b) => b.points - a.points)
                                .forEach(obj => childrenDiv.appendChild(obj.div));
                        }
                    });
                } else {
                    childrenDiv.textContent = 'No children found';
                }  
            }

            totaltreePointsDiv.textContent = Math.round(points_from_children * (1 + (boost_pct === "?" ? 0 : boost_pct) / 100)) + " possible to parent (" + points_from_children + " boosted by " + boost_pct + "%)";

            return childrenDiv;
        }

        async function createChildDiv(child, showbutton) {
            // Create a container div for the child
            const childDiv = document.createElement('div');
            const nestedDiv = document.createElement('div');
            nestedDiv.className = 'child-container';
            childDiv.appendChild(nestedDiv);

            childDiv.id = 'child-div-' + (child.username || child);
            childDiv.className = 'tree-child-row';
            // Add attributes for each child data element to the childDiv
            if (child && typeof child === 'object') {
                for (const [key, value] of Object.entries(child)) {
                    if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {
                        childDiv.setAttribute(key, value);
                    }
                }
            }
            const treePointsSpan = document.createElement('span');
            if (child.active_referral_tree == 1) {
                treePointstoParent = 0.5 * (child.points + child.tree_points);
            } else {
                treePointstoParent = 0.5 * child.points;
            }

            if (child.parent) {
                // If child.parent is defined, make this a clickable element
                const parentLink = document.createElement('a');
                parentLink.href = '#';
                parentLink.textContent = (child.tree_points_to_parent || (0.5 * (child.points + child.tree_points))) + " to " + child.parent;
                parentLink.style.cursor = 'pointer';
                parentLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    show_parent_tree(child.parent);
                });
                treePointsSpan.appendChild(parentLink);
            } else {
                treePointsSpan.textContent = (child.tree_points_to_parent || (0.5 * (child.points + child.tree_points))) + " to parent";
            }
            treePointsSpan.className = 'tree-points';
            nestedDiv.appendChild(treePointsSpan);

            // Username span
            const usernameSpan = document.createElement('span');
            usernameSpan.textContent = child.username || child; // fallback if child is just a string

            nestedDiv.appendChild(usernameSpan);

            // Add a small "0" under the username, centered
            const pointsUnderUsername = document.createElement('span');
            pointsUnderUsername.textContent = (child.points || 0) + " total";
            pointsUnderUsername.className = 'points-under-username';
            usernameSpan.appendChild(document.createElement('br'));
            usernameSpan.appendChild(pointsUnderUsername);

            const fromTreePointsSpan = document.createElement('span');
            fromTreePointsSpan.className = 'tree-points';
            if (child.active_referral_tree == 0) {
                fromTreePointsSpan.innerHTML = "<s>" + (child.tree_points || 0) + " from tree</s>";
            } else {
                fromTreePointsSpan.textContent = (child.tree_points || 0) + " from tree";
            }
            nestedDiv.appendChild(fromTreePointsSpan);

            if (showbutton == 1) {
                // "+" button
                const plusBtn = document.createElement('button');
                plusBtn.textContent = child.descendants;
                plusBtn.classList.add('plus-btn', 'tree-plus-btn');
                plusBtn.id = 'plus-btn-' + (child.username || child);
                nestedDiv.appendChild(plusBtn);
            }

            return childDiv;
        }

        function addPlusButtonListeners(parentDiv) {
            // Add event listeners for all "+" buttons
            const plusButtons = parentDiv.querySelectorAll('.plus-btn');
            plusButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const parentDiv = btn.parentElement.parentElement;
                    const divId = parentDiv.id || null;
                    const attributes = {};
                    for (let attr of parentDiv.attributes) {
                        attributes[attr.name] = attr.value;
                    }
                    handlePlusButtonClick(divId, attributes);
                });
            });
        }

        async function show_parent_tree(parent_username) {
            // When called, put parent_username into the participants-search box and click "Get Stats"
            const searchBox = document.getElementById('participants-search');
            if (searchBox) {
                searchBox.value = parent_username;
                // Trigger input event in case there is a listener that filters the dropdown
                const event = new Event('input', { bubbles: true });
                searchBox.dispatchEvent(event);
            }
            // Wait a short time to allow dropdown to update, then click the button
            setTimeout(() => {
                const getStatsBtn = document.getElementById('get-stats-btn');
                if (getStatsBtn) {
                    getStatsBtn.click();
                }
            }, 200);


        }



        async function handlePlusButtonClick(divId, attributes) {
            const plusBtn = document.getElementById('plus-btn-' + attributes.username);
            plusBtn.disabled = true;
            setTimeout(() => { plusBtn.disabled = false; }, 300); // Prevent rapid multiple clicks
            const parentDiv = document.getElementById(divId);
            if (plusBtn.textContent === '-') {
                const childrenDivId = 'children-div-' + attributes.username ;
                const childrenDiv = document.getElementById(childrenDivId);
                childrenDiv.remove();
                
                plusBtn.onclick = null;
                plusBtn.textContent = attributes.descendants;
                return;
            }
            show_spinner(plusBtn);
            // Prevent multiple childrenDivs from being added for the same parent
            if (!parentDiv.querySelector('children-div-' + attributes.username)) {
                const parentWallet = await getWalletAddress(attributes.username, walletAddress);
                const parentStats = {
                    boost_percent: attributes.boost_percent,
                    points: attributes.points
                }
                const childrenDiv = await createChildrenDiv(attributes.username, parentWallet, parentStats);
                childrenDiv.className = 'children-div';
                parentDiv.appendChild(childrenDiv);
                addPlusButtonListeners(childrenDiv);
            }
            hide_spinner(plusBtn);
            plusBtn.textContent = '-';
            
        }

    });

  </script>
</body>

</html>